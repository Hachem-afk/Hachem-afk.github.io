<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raytracing Games - Portfolio Hachem Lamrini</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="interactive-bg"></div>
    <canvas class="bg-canvas" id="bgCanvas"></canvas>
    
    <div class="custom-cursor" id="cursor"></div>
    <div class="ambient-light" id="ambientLight"></div>
    
    <a href="#" class="back-button" onclick="window.history.back()">
        <i class="fas fa-arrow-left"></i> Retour au portfolio
    </a>

    <div class="container">
        <div class="header">
            <h1 class="title">Raytracing Engine</h1>
            <p class="subtitle">Simulations physiques ultra-réalistes avec raytracing optimisé</p>
        </div>

        <div class="games-grid">
            <!-- Ocean Raytracing Simulation -->
            <div class="game-card" onclick="startRaytracing('ocean')">
                <div class="loading-overlay" id="oceanLoading">
                    <div class="loading-spinner"></div>
                </div>
                <canvas id="oceanCanvas" class="game-canvas" width="500" height="450"></canvas>
                <div class="performance-info" id="oceanPerf">FPS: 0 | Rayons: 0</div>
                <div class="game-info">
                    <h3 class="game-title">Ocean Raytracing</h3>
                    <p class="game-desc">Simulation océanique avec raytracing volumétrique et caustiques dynamiques.</p>
                </div>
            </div>

            <!-- Crystal Fractal Raytracer -->
            <div class="game-card" onclick="startRaytracing('crystal')">
                <div class="loading-overlay" id="crystalLoading">
                    <div class="loading-spinner"></div>
                </div>
                <canvas id="crystalCanvas" class="game-canvas" width="500" height="450"></canvas>
                <div class="performance-info" id="crystalPerf">FPS: 0 | Fractales: 0</div>
                <div class="game-info">
                    <h3 class="game-title">Crystal Fractal Raytracer</h3>
                    <p class="game-desc">Rendu de cristaux fractals avec raytracing récursif et dispersion chromatique.</p>
                </div>
            </div>
        </div>

        <!-- Error message display -->
        <div id="errorMessage" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText"></span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/performance-monitor.js"></script>
    <script src="js/particle-system.js"></script>
    <script src="js/raytracing-engine.js"></script>
    <script src="js/ocean-simulation.js"></script>
    <script src="js/crystal-simulation.js"></script>
    
    <script>
        // Global application state
        let activeGame = null;
        let bgAnimationId;
        let mouseX = 0, mouseY = 0;
        let cursorTrails = [];
        
        // Performance monitor instance
        let performanceMonitor;
        
        // Particle system instance
        let particleSystem;
        
        // Raytracing engines
        let oceanEngine, crystalEngine;

        // Initialize application
        function init() {
            try {
                // Check WebGL support
                if (!Utils.checkWebGLSupport()) {
                    showError("WebGL n'est pas supporté par votre navigateur. Veuillez utiliser un navigateur moderne.");
                    return;
                }

                // Initialize performance monitor
                performanceMonitor = new PerformanceMonitor();
                
                // Initialize particle system
                particleSystem = new ParticleSystem(document.getElementById('bgCanvas'));
                
                // Initialize raytracing engines
                oceanEngine = new OceanSimulation();
                crystalEngine = new CrystalSimulation();
                
                // Initialize cursor effects
                initCursorEffects();
                
                // Start background animation
                startBackgroundAnimation();
                
                console.log("Raytracing portfolio initialized successfully");
                
            } catch (error) {
                console.error("Initialization error:", error);
                showError("Erreur d'initialisation: " + error.message);
            }
        }

        // Initialize cursor effects
        function initCursorEffects() {
            const cursor = document.getElementById('cursor');
            const ambientLight = document.getElementById('ambientLight');
            
            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                
                // Update cursor position
                cursor.style.left = (mouseX - 10) + 'px';
                cursor.style.top = (mouseY - 10) + 'px';
                
                // Update ambient light position
                ambientLight.style.left = (mouseX - 150) + 'px';
                ambientLight.style.top = (mouseY - 150) + 'px';
                
                // Add cursor trail
                addCursorTrail(mouseX, mouseY);
            });
        }

        // Add cursor trail effect
        function addCursorTrail(x, y) {
            const trail = document.createElement('div');
            trail.className = 'cursor-trail';
            trail.style.left = (x - 3) + 'px';
            trail.style.top = (y - 3) + 'px';
            document.body.appendChild(trail);
            
            cursorTrails.push(trail);
            
            // Animate trail
            setTimeout(() => {
                trail.style.opacity = '0';
                trail.style.transform = 'scale(0)';
            }, 50);
            
            // Remove trail after animation
            setTimeout(() => {
                if (trail.parentNode) {
                    trail.parentNode.removeChild(trail);
                }
                const index = cursorTrails.indexOf(trail);
                if (index > -1) {
                    cursorTrails.splice(index, 1);
                }
            }, 500);
            
            // Limit trail count for performance
            if (cursorTrails.length > 10) {
                const oldTrail = cursorTrails.shift();
                if (oldTrail.parentNode) {
                    oldTrail.parentNode.removeChild(oldTrail);
                }
            }
        }

        // Start background animation
        function startBackgroundAnimation() {
            function animate() {
                particleSystem.update(mouseX, mouseY);
                particleSystem.render();
                bgAnimationId = requestAnimationFrame(animate);
            }
            animate();
        }

        // Start raytracing simulation
        function startRaytracing(type) {
            if (activeGame === type) return;
            
            // Stop previous game
            if (activeGame) {
                stopRaytracing(activeGame);
            }
            
            activeGame = type;
            
            try {
                const loadingElement = document.getElementById(type + 'Loading');
                loadingElement.style.display = 'flex';
                
                setTimeout(() => {
                    if (type === 'ocean') {
                        oceanEngine.init('oceanCanvas', 'oceanPerf');
                        oceanEngine.start();
                    } else if (type === 'crystal') {
                        crystalEngine.init('crystalCanvas', 'crystalPerf');
                        crystalEngine.start();
                    }
                    
                    loadingElement.style.display = 'none';
                }, 1000);
                
            } catch (error) {
                console.error(`Error starting ${type} simulation:`, error);
                showError(`Erreur lors du démarrage de la simulation ${type}: ${error.message}`);
                document.getElementById(type + 'Loading').style.display = 'none';
            }
        }

        // Stop raytracing simulation
        function stopRaytracing(type) {
            try {
                if (type === 'ocean' && oceanEngine) {
                    oceanEngine.stop();
                } else if (type === 'crystal' && crystalEngine) {
                    crystalEngine.stop();
                }
            } catch (error) {
                console.error(`Error stopping ${type} simulation:`, error);
            }
        }

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorElement.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (particleSystem) {
                particleSystem.resize();
            }
            
            if (oceanEngine && activeGame === 'ocean') {
                oceanEngine.resize();
            }
            
            if (crystalEngine && activeGame === 'crystal') {
                crystalEngine.resize();
            }
        });

        // Handle page visibility changes for performance
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Pause animations when tab is not visible
                if (bgAnimationId) {
                    cancelAnimationFrame(bgAnimationId);
                }
                if (activeGame) {
                    stopRaytracing(activeGame);
                }
            } else {
                // Resume animations when tab becomes visible
                startBackgroundAnimation();
                if (activeGame) {
                    startRaytracing(activeGame);
                }
            }
        });

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
        
        // Handle page unload for cleanup
        window.addEventListener('beforeunload', () => {
            if (bgAnimationId) {
                cancelAnimationFrame(bgAnimationId);
            }
            if (activeGame) {
                stopRaytracing(activeGame);
            }
        });
    </script>
</body>
</html>